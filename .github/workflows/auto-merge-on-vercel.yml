name: Auto-merge on Vercel success

on:
  check_run:
    types: [completed]

permissions:
  pull-requests: write
  contents: write
  checks: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Auto-merge when Vercel check succeeds
        uses: actions/github-script@v6
        with:
          script: |
            const checkRun = context.payload.check_run;
            if (!checkRun) return;

            const name = (checkRun.name || '').toLowerCase();
            const conclusion = checkRun.conclusion;

            // only act on Vercel checks that succeeded
            if (conclusion !== 'success' || !name.includes('vercel')) {
              core.info(`Skipping: name=${checkRun.name} conclusion=${conclusion}`);
              return;
            }

            const prs = (checkRun.check_suite && checkRun.check_suite.pull_requests) || [];
            if (!prs.length) {
              core.info('No associated PRs found â€” nothing to merge.');
              return;
            }

            for (const pr of prs) {
              const prNumber = pr.number;
              core.info(`Attempting to merge PR #${prNumber} (check: ${checkRun.name})`);
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  merge_method: 'merge'
                });
                core.info(`Merged PR #${prNumber}`);
              } catch (err) {
                core.error(`Could not merge PR #${prNumber}: ${err.message}`);
              }
            }
