name: Auto-merge on Vercel success

on:
  check_run:
    types: [completed]
  workflow_dispatch: {}

permissions:
  pull-requests: write
  contents: write
  checks: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Auto-merge when Vercel check succeeds
        uses: actions/github-script@v6
        with:
          script: |
            const checkRun = context.payload.check_run;
            if (!checkRun) return;

            const name = (checkRun.name || '').toLowerCase();
            const conclusion = checkRun.conclusion;

            // only act on Vercel checks that succeeded
            if (conclusion !== 'success' || !name.includes('vercel')) {
              core.info(`Skipping: name=${checkRun.name} conclusion=${conclusion}`);
              return;
            }

            const prs = (checkRun.check_suite && checkRun.check_suite.pull_requests) || [];
            if (!prs.length) {
              core.info('No associated PRs found — nothing to merge.');
              return;
            }

            for (const pr of prs) {
              const prNumber = pr.number;
              const headRef = pr.head.ref;
              core.info(`Processing PR #${prNumber} (head: ${headRef})`);

              // Try to merge the PR directly
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  merge_method: 'merge'
                });
                core.info(`Merged PR #${prNumber}`);
                continue;
              } catch (err) {
                core.info(`Initial merge failed for PR #${prNumber}: ${err.message}`);
              }

              // If merge failed, try to update the PR branch by merging main into it, then retry
              try {
                core.info(`Attempting to update branch ${headRef} by merging 'main' into it...`);
                await github.rest.repos.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  base: headRef,
                  head: 'main'
                });

                core.info(`Branch ${headRef} updated from main — retrying PR merge...`);

                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  merge_method: 'merge'
                });

                core.info(`Merged PR #${prNumber} after updating branch`);
              } catch (err2) {
                core.error(`Could not auto-update/merge PR #${prNumber}: ${err2.message}`);
              }
            }
